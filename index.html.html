<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão | Portaria e Zeladoria (Online)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50; --secondary: #34495e; --accent: #2980b9;
            --success: #27ae60; --warning: #f39c12; --danger: #c0392b;
            --visitante: #8e44ad; --servidor: #2980b9; --recepcao: #16a085;
            --estacionado: #d35400; --edit: #e67e22; --info: #17a2b8;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; }
        body { background-color: #f4f7f6; color: #333; padding-bottom: 50px;}

        /* LOGIN */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 2rem; border-radius: 10px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box h2 { color: var(--primary); margin-bottom: 1.5rem; }
        .login-box input { margin-bottom: 1rem; }
        .login-error { color: var(--danger); font-size: 0.9rem; margin-top: 10px; display: none; }

        /* HEADER E NAV */
        #app-content { display: none; }
        header { background-color: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 1.5rem; }
        
        .nav-tabs { display: flex; background: var(--secondary); padding: 0 2rem; overflow-x: auto;}
        .tab-btn { background: none; border: none; color: #bdc3c7; padding: 1rem 2rem; cursor: pointer; font-weight: bold; transition: 0.3s; border-bottom: 4px solid transparent; white-space: nowrap; }
        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: white; border-bottom-color: var(--accent); }
        .hidden-tab { display: none !important; }

        main { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }

        /* CARDS E FORMULARIOS */
        .dashboard-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary); display: flex; align-items: center; justify-content: space-between; }
        .metric-info h3 { font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px; }
        .metric-info p { font-size: 1.8rem; font-weight: bold; color: var(--primary); margin: 0; }
        .metric-icon { font-size: 2rem; opacity: 0.2; }

        .card-total { border-left-color: var(--primary); }
        .card-pendente { border-left-color: var(--warning); }
        .card-andamento { border-left-color: var(--accent); }
        .card-concluido { border-left-color: var(--success); }
        .card-recepcao { border-left-color: var(--recepcao); }
        .card-estacionado { border-left-color: var(--estacionado); }

        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 2rem; border-top: 4px solid var(--accent); }
        .card h2 { margin-bottom: 1rem; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        
        /* FILTROS */
        .filter-container { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-bottom: 1rem; background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #e9ecef; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
        .filter-group label { font-weight: bold; color: var(--secondary); font-size: 0.85rem;}
        .filter-group input, .filter-group select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        .tipo-selector { display: flex; gap: 20px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .radio-label input { width: auto; margin-right: 8px; }
        
        input, select, textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        input:focus, select:focus { outline: none; border-color: var(--accent); }

        .btn-container { display: flex; gap: 10px; }
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1; transition: 0.2s; }
        button.btn-primary:hover { filter: brightness(90%); }
        button.btn-cancel { background: #95a5a6; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: var(--secondary); color: white; font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background-color: #f9f9f9; }

        .badge { padding: 5px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; display: inline-block; min-width: 80px; text-align: center;}
        
        .bg-pendente { background-color: var(--warning); }
        .bg-andamento { background-color: var(--accent); }
        .bg-concluido { background-color: var(--success); }
        .bg-estacionado { background-color: var(--estacionado); } 
        .bg-saiu { background-color: #95a5a6; } 
        .bg-visitante-ativo { background-color: var(--recepcao); }

        .action-btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; color: white; font-size: 0.8rem; }
        .btn-check { background-color: var(--success); }
        .btn-delete { background-color: var(--danger); }
        .btn-edit { background-color: var(--edit); }
        .btn-baixa { background-color: var(--danger); }

        .time-badge { background: #ecf0f1; color: #7f8c8d; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; border: 1px solid #bdc3c7; display: inline-flex; align-items: center; gap: 5px;}
        .time-badge i { font-size: 0.8rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading { text-align: center; padding: 20px; font-style: italic; color: #666; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> Acesso Restrito</h2>
            <p style="margin-bottom: 1rem; color: #666;">Identifique-se para acessar o sistema.</p>
            <input type="text" id="login-user" placeholder="Usuário" onkeyup="checkEnter(event)">
            <input type="password" id="login-pass" placeholder="Senha" onkeyup="checkEnter(event)">
            <button onclick="fazerLogin()" class="btn-primary">Entrar</button>
            <p id="login-error" class="login-error">Usuário ou senha incorretos!</p>
        </div>
    </div>

    <div id="app-content">
        <header>
            <h1><i class="fas fa-building"></i> COGESPA - ONLINE <i class="fas fa-wifi" style="font-size:0.8rem; color: #2ecc71;"></i></h1>
            <div style="text-align: right;">
                <small id="user-display" style="display:block; font-weight:bold; color: var(--accent);"></small>
                <small id="date-display"></small>
                <a href="#" onclick="logout()" style="color: white; font-size: 0.8rem; margin-left: 10px;">(Sair)</a>
            </div>
        </header>

        <nav class="nav-tabs">
            <button id="tab-demandas" class="tab-btn" onclick="switchTab('demandas')"><i class="fas fa-clipboard-list"></i> Demandas</button>
            <button id="tab-visitantes" class="tab-btn" onclick="switchTab('visitantes')"><i class="fas fa-users"></i> Recepção</button>
            <button id="tab-veiculos" class="tab-btn" onclick="switchTab('veiculos')"><i class="fas fa-car"></i> Garagem</button>
        </nav>

        <main>
            <section id="demandas" class="section">
                <div class="dashboard-panel">
                    <div class="metric-card card-total"><div class="metric-info"><h3>Total</h3><p id="dash-demanda-total">...</p></div><i class="fas fa-folder-open metric-icon" style="color: var(--primary)"></i></div>
                    <div class="metric-card card-pendente"><div class="metric-info"><h3>Pendentes</h3><p id="dash-demanda-pendente">...</p></div><i class="fas fa-clock metric-icon" style="color: var(--warning)"></i></div>
                    <div class="metric-card card-andamento"><div class="metric-info"><h3>Em Andamento</h3><p id="dash-demanda-andamento">...</p></div><i class="fas fa-tools metric-icon" style="color: var(--accent)"></i></div>
                    <div class="metric-card card-concluido"><div class="metric-info"><h3>Concluídas</h3><p id="dash-demanda-concluido">...</p></div><i class="fas fa-check-circle metric-icon" style="color: var(--success)"></i></div>
                </div>

                <div class="card">
                    <h2 id="titulo-form-demanda"><i class="fas fa-plus-circle"></i> Nova Solicitação</h2>
                    <form id="form-demanda">
                        <input type="hidden" id="demanda-id-edit" value="">
                        <div class="form-grid">
                            <input type="text" id="demanda-titulo" placeholder="Descrição do Serviço" required>
                            <input type="text" id="demanda-setor" placeholder="Local / Setor" required>
                            <input type="text" id="demanda-solicitante" placeholder="Nome do Solicitante" required>
                            <select id="demanda-prioridade">
                                <option value="Baixa">Prioridade Baixa</option>
                                <option value="Média">Prioridade Média</option>
                                <option value="Alta">Prioridade Alta</option>
                            </select>
                            <input type="date" id="demanda-data" required>
                            <select id="demanda-status-edit" style="display:none">
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluído">Concluído</option>
                            </select>
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn-primary" id="btn-submit-demanda">Registrar Demanda</button>
                            <button type="button" class="btn-cancel" id="btn-cancel-demanda" onclick="cancelarEdicaoDemanda()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="filter-container">
                        <div class="filter-group"><label>Mês Ref:</label><input type="month" id="filtro-mes-demanda" onchange="window.renderizarApenasDemandas()"></div>
                        
                        <div class="filter-group"><label>Buscar (Serviço/Setor):</label><input type="text" id="filtro-texto-demanda" onkeyup="window.renderizarApenasDemandas()" placeholder="Ex: Lâmpada, Copa..."></div>
                        
                        <div class="filter-group"><label>Status:</label>
                            <select id="filtro-status-demanda" onchange="window.renderizarApenasDemandas()">
                                <option value="">Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Concluído">Concluído</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tabela-demandas">
                            <thead><tr><th>Data</th><th>Prioridade</th><th>Serviço</th><th>Status</th><th>Tempo</th><th>Ações</th></tr></thead>
                            <tbody><tr><td colspan="6" class="loading">Carregando dados da nuvem...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="visitantes" class="section">
                <div class="dashboard-panel">
                    <div class="metric-card card-recepcao"><div class="metric-info"><h3>Visitantes Ativos</h3><p id="dash-visitantes-ativos">...</p></div><i class="fas fa-users metric-icon" style="color: var(--recepcao)"></i></div>
                    <div class="metric-card card-total"><div class="metric-info"><h3>Total no Período</h3><p id="dash-visitantes-total">...</p></div><i class="fas fa-list metric-icon"></i></div>
                </div>

                <div class="card">
                    <h2 id="titulo-form-visitante"><i class="fas fa-user-plus"></i> Cadastrar Visitante</h2>
                    <form id="form-visitante">
                        <input type="hidden" id="visitante-id-edit" value="">
                        <div class="form-grid">
                            <input type="text" id="vis-nome" placeholder="Nome Completo" required>
                            <input type="text" id="vis-doc" placeholder="Documento (RG/CPF)" required>
                            <input type="text" id="vis-empresa" placeholder="Empresa (Opcional)">
                            <input type="text" id="vis-contato" placeholder="E-mail / Telefone">
                            <input type="text" id="vis-responsavel" placeholder="Pessoa Responsável (Anfitrião)" required>
                            <input type="text" id="vis-finalidade" placeholder="Finalidade da Visita" required>
                            <div><label style="font-size:0.8rem">Hora Entrada</label><input type="datetime-local" id="vis-entrada" required></div>
                            <select id="vis-status-edit" style="display:none"><option value="Ativo">Na Empresa</option><option value="Saiu">Saiu</option></select>
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn-primary" id="btn-submit-vis">Registrar Entrada</button>
                            <button type="button" class="btn-cancel" id="btn-cancel-vis" onclick="cancelarEdicaoVisitante()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="filter-container">
                        <div class="filter-group"><label>Mês de Referência:</label><input type="month" id="filtro-mes-vis" onchange="window.renderizarApenasVisitantes()"></div>
                        <div class="filter-group"><label>Buscar (Nome/Doc/Empresa):</label><input type="text" id="filtro-busca-vis" onkeyup="window.renderizarApenasVisitantes()" placeholder="Digite para filtrar..."></div>
                    </div>
                    <div class="table-container">
                        <table id="tabela-visitantes">
                            <thead><tr><th>Status</th><th>Visitante</th><th>Empresa/Doc</th><th>Responsável/Finalidade</th><th>Entrada/Saída</th><th>Ação</th></tr></thead>
                            <tbody><tr><td colspan="6" class="loading">Carregando dados da nuvem...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="veiculos" class="section">
                <div class="dashboard-panel">
                    <div class="metric-card card-estacionado"><div class="metric-info"><h3>Estacionados</h3><p id="dash-frota-estacionados">...</p></div><i class="fas fa-parking metric-icon" style="color: var(--estacionado)"></i></div>
                    <div class="metric-card card-total"><div class="metric-info"><h3>Acessos</h3><p id="dash-frota-total">...</p></div><i class="fas fa-car metric-icon" style="color: var(--primary)"></i></div>
                    <div class="metric-card card-servidor"><div class="metric-info"><h3>Servidores</h3><p id="dash-servidor-count">...</p></div><i class="fas fa-id-badge metric-icon" style="color: var(--servidor)"></i></div>
                    <div class="metric-card card-visitante"><div class="metric-info"><h3>Visitantes</h3><p id="dash-visitante-count">...</p></div><i class="fas fa-user-tag metric-icon" style="color: var(--visitante)"></i></div>
                </div>

                <div class="card">
                    <h2 id="titulo-form-veiculo"><i class="fas fa-parking"></i> Registrar Entrada (Garagem)</h2>
                    <form id="form-veiculo">
                        <input type="hidden" id="veiculo-id-edit" value="">
                        <div class="tipo-selector">
                            <label class="radio-label"><input type="radio" name="tipoFluxo" id="radio-servidor" value="servidor" checked onclick="atualizarLabels()"><span style="color: var(--servidor)">Entrada Servidor</span></label>
                            <label class="radio-label"><input type="radio" name="tipoFluxo" id="radio-visitante" value="visitante" onclick="atualizarLabels()"><span style="color: var(--visitante)">Entrada Visitante</span></label>
                        </div>
                        <div class="form-grid">
                            <input type="text" id="veiculo-carro" placeholder="Veículo (Modelo - Placa)" required>
                            <input type="text" id="veiculo-motorista" placeholder="Nome do Condutor" required>
                            <input type="text" id="veiculo-setor" placeholder="Setor" required>
                            <input type="text" id="veiculo-contato" placeholder="Ramal / Contato">
                            <input type="text" id="veiculo-destino" placeholder="Obs / Destino">
                            <div><label style="font-size:0.8rem">KM Entrada</label><input type="number" id="veiculo-km-saida" placeholder="0"></div>
                            <div><label style="font-size:0.8rem">Hora Entrada</label><input type="datetime-local" id="veiculo-hora-saida" required></div>
                            <div id="container-status-veiculo" style="display:none"><label style="font-size:0.8rem;color:var(--edit)">Status</label><select id="veiculo-status-edit"><option value="Aberto">Estacionado</option><option value="Fechado">Finalizado</option></select></div>
                        </div>
                        <div class="btn-container">
                            <button type="submit" class="btn-primary" id="btn-submit-veiculo">Registrar Entrada</button>
                            <button type="button" class="btn-cancel" id="btn-cancel-veiculo" onclick="cancelarEdicaoVeiculo()">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <div class="filter-container">
                        <div class="filter-group"><label>Mês Ref:</label><input type="month" id="filtro-mes-frota" onchange="window.renderizarApenasFrota()"></div>
                        <div class="filter-group"><label>Buscar:</label><input type="text" id="filtro-busca-frota" onkeyup="window.renderizarApenasFrota()" placeholder="Nome/Placa..."></div>
                    </div>
                    <div class="table-container">
                        <table id="tabela-veiculos">
                            <thead><tr><th>Status</th><th>Tipo</th><th>Condutor</th><th>Veículo</th><th>Setor</th><th>Entrada/Saída</th><th>Ações</th></tr></thead>
                            <tbody><tr><td colspan="6" class="loading">Carregando dados da nuvem...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // SUA CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAEU-SuZxNkN6R6QRhL2Iky4vyffIOb3HY",
            authDomain: "zeladoriaapp-9aaed.firebaseapp.com",
            databaseURL: "https://zeladoriaapp-9aaed-default-rtdb.firebaseio.com",
            projectId: "zeladoriaapp-9aaed",
            storageBucket: "zeladoriaapp-9aaed.firebasestorage.app",
            messagingSenderId: "982940200696",
            appId: "1:982940200696:web:103df43dbf2a62ef8b150d"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // VARIÁVEIS GLOBAIS DE DADOS
        let demandas = [];
        let frota = [];
        let visitantes = [];

        // --- SISTEMA DE LOGIN COM MEMÓRIA (PERSISTÊNCIA F5) ---
        const CREDENCIAIS = {
            'admin': { pass: 'admin2451', role: 'admin', nome: 'Administrador' },
            'zeladoria': { pass: 'zeladoria', role: 'zeladoria', nome: 'Zeladoria' },
            'portaria': { pass: 'portaria', role: 'portaria', nome: 'Portaria' },
            'recepcao': { pass: 'recepcao', role: 'recepcao', nome: 'Recepção' }
        };
        let currentUserRole = null;

        // 1. VERIFICAÇÃO AUTOMÁTICA AO CARREGAR A PÁGINA
        const usuarioSalvo = localStorage.getItem('zeladoria_user');
        if (usuarioSalvo) {
            const user = JSON.parse(usuarioSalvo);
            setTimeout(() => {
                currentUserRole = user.role;
                iniciarSistema(user);
            }, 100);
        }

        window.checkEnter = function(e) { if(e.key === 'Enter') window.fazerLogin(); }
        
        window.fazerLogin = function() {
            const userKey = document.getElementById('login-user').value.toLowerCase();
            const pass = document.getElementById('login-pass').value;
            
            if (CREDENCIAIS[userKey] && CREDENCIAIS[userKey].pass === pass) {
                currentUserRole = CREDENCIAIS[userKey].role;
                localStorage.setItem('zeladoria_user', JSON.stringify(CREDENCIAIS[userKey]));
                iniciarSistema(CREDENCIAIS[userKey]);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function iniciarSistema(userData) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('user-display').innerText = `Olá, ${userData.nome}`;
            
            const tDemandas = document.getElementById('tab-demandas');
            const tVisitantes = document.getElementById('tab-visitantes');
            const tVeiculos = document.getElementById('tab-veiculos');

            if (userData.role === 'zeladoria') {
                tVisitantes.classList.add('hidden-tab'); tVeiculos.classList.add('hidden-tab'); window.switchTab('demandas');
            } else if (userData.role === 'portaria') {
                tDemandas.classList.add('hidden-tab'); window.switchTab('veiculos');
            } else if (userData.role === 'recepcao') {
                tDemandas.classList.add('hidden-tab'); tVeiculos.classList.add('hidden-tab'); window.switchTab('visitantes');
            } else { 
                if(!document.querySelector('.section.active')) window.switchTab('demandas');
            }
        }

        window.logout = function() { 
            localStorage.removeItem('zeladoria_user');
            location.reload(); 
        }

        // --- NAVEGAÇÃO E ÚTEIS ---
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('pt-BR');
        document.getElementById('demanda-data').valueAsDate = new Date();
        document.getElementById('vis-entrada').value = new Date().toISOString().slice(0,16);

        window.switchTab = function(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const btn = document.getElementById('tab-' + tabId); if(btn) btn.classList.add('active');
        }

        function calcularTempoDecorrido(dataInicio, dataFim = new Date()) {
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            const diffMs = fim - inicio;
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHoras = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            if (diffDias > 0) return `${diffDias}d ${diffHoras}h`;
            return `${diffHoras} horas`;
        }

        function formatarData(dataISO) { if(!dataISO) return ''; const [ano, mes, dia] = dataISO.split('-'); return `${dia}/${mes}/${ano}`; }

        // ==================================================================
        // === LÓGICA DO FIREBASE (GRAVAÇÃO E LEITURA) ===
        // ==================================================================

        // --- 1. DEMANDAS ---
        const formDemanda = document.getElementById('form-demanda');
        formDemanda.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('demanda-id-edit').value;
            const id = idEdicao || Date.now(); 
            
            const novaDemanda = {
                id: id,
                titulo: document.getElementById('demanda-titulo').value,
                setor: document.getElementById('demanda-setor').value,
                solicitante: document.getElementById('demanda-solicitante').value,
                prioridade: document.getElementById('demanda-prioridade').value,
                data: document.getElementById('demanda-data').value,
                status: idEdicao ? document.getElementById('demanda-status-edit').value : 'Pendente',
                dataFim: null 
            };

            if(idEdicao) {
                const itemAntigo = demandas.find(d => d.id == id);
                if(novaDemanda.status === 'Concluído' && (!itemAntigo || itemAntigo.status !== 'Concluído')) {
                    novaDemanda.dataFim = new Date().toISOString();
                } else if (itemAntigo && itemAntigo.dataFim) {
                    novaDemanda.dataFim = itemAntigo.dataFim;
                }
            }

            set(ref(db, 'demandas/' + id), novaDemanda)
                .then(() => { cancelarEdicaoDemanda(); })
                .catch((error) => alert("Erro ao salvar: " + error));
        });

        onValue(ref(db, 'demandas'), (snapshot) => {
            const data = snapshot.val();
            demandas = data ? Object.values(data) : [];
            demandas.sort((a,b) => b.id - a.id);
            window.renderizarApenasDemandas();
        });

        window.editarDemanda = function(id) {
            const d = demandas.find(item => item.id === id); if (!d) return;
            document.getElementById('demanda-id-edit').value = d.id;
            document.getElementById('demanda-titulo').value = d.titulo; document.getElementById('demanda-setor').value = d.setor;
            document.getElementById('demanda-solicitante').value = d.solicitante; document.getElementById('demanda-prioridade').value = d.prioridade;
            document.getElementById('demanda-data').value = d.data;
            document.getElementById('titulo-form-demanda').innerHTML = '<i class="fas fa-edit"></i> Editando';
            document.getElementById('btn-submit-demanda').innerText = "Salvar"; document.getElementById('btn-submit-demanda').style.backgroundColor = "var(--edit)";
            document.getElementById('btn-cancel-demanda').style.display = "block";
            const selectStatus = document.getElementById('demanda-status-edit'); selectStatus.style.display = "block"; selectStatus.value = d.status;
            document.getElementById('demandas').scrollIntoView({behavior: 'smooth'});
        }

        window.cancelarEdicaoDemanda = function() {
            document.getElementById('demanda-id-edit').value = ""; formDemanda.reset(); document.getElementById('demanda-data').valueAsDate = new Date();
            document.getElementById('titulo-form-demanda').innerHTML = '<i class="fas fa-plus-circle"></i> Nova Solicitação';
            document.getElementById('btn-submit-demanda').innerText = "Registrar Demanda"; document.getElementById('btn-submit-demanda').style.backgroundColor = "var(--accent)";
            document.getElementById('btn-cancel-demanda').style.display = "none"; document.getElementById('demanda-status-edit').style.display = "none";
        }

        window.renderizarApenasDemandas = function() {
            const filtroMes = document.getElementById('filtro-mes-demanda').value; 
            const filtroStatus = document.getElementById('filtro-status-demanda').value;
            
            // NOVO: Filtro de Texto
            const filtroTexto = document.getElementById('filtro-texto-demanda').value.toLowerCase();

            const lista = demandas.filter(d => {
                const bateData = !filtroMes || d.data.startsWith(filtroMes);
                const bateStatus = !filtroStatus || d.status === filtroStatus;
                
                // NOVO: Verifica se o texto existe em Título, Setor ou Solicitante
                const textoGeral = (d.titulo + ' ' + d.setor + ' ' + d.solicitante).toLowerCase();
                const bateTexto = !filtroTexto || textoGeral.includes(filtroTexto);

                return bateData && bateStatus && bateTexto;
            });

            document.getElementById('dash-demanda-total').innerText = lista.length;
            document.getElementById('dash-demanda-pendente').innerText = lista.filter(d => d.status === 'Pendente').length;
            document.getElementById('dash-demanda-andamento').innerText = lista.filter(d => d.status === 'Em Andamento').length;
            document.getElementById('dash-demanda-concluido').innerText = lista.filter(d => d.status === 'Concluído').length;

            const tbody = document.querySelector('#tabela-demandas tbody'); tbody.innerHTML = '';
            lista.forEach(d => {
                const tr = document.createElement('tr');
                let badgeClass = d.status === 'Pendente' ? 'bg-pendente' : (d.status === 'Em Andamento' ? 'bg-andamento' : 'bg-concluido');
                
                let tempoDisplay = "";
                if (d.status === 'Concluído' && d.dataFim) {
                    tempoDisplay = `<span class="time-badge"><i class="fas fa-stopwatch"></i> ${calcularTempoDecorrido(d.data, d.dataFim)} (Total)</span>`;
                } else {
                    tempoDisplay = `<span class="time-badge" style="background:#fff3cd; color:#856404; border-color:#ffeeba"><i class="fas fa-hourglass-half"></i> ${calcularTempoDecorrido(d.data)}</span>`;
                }
                const btnAvancar = d.status !== 'Concluído' ? `<button onclick="avancarStatus(${d.id})" class="action-btn btn-check"><i class="fas fa-arrow-right"></i></button>` : '';
                tr.innerHTML = `<td>${formatarData(d.data)}</td><td><span class="badge" style="background:#7f8c8d">${d.prioridade}</span></td><td><strong>${d.titulo}</strong><br><small>${d.solicitante} (${d.setor})</small></td><td><span class="badge ${badgeClass}">${d.status}</span></td><td>${tempoDisplay}</td><td style="min-width:120px">${btnAvancar}<button onclick="editarDemanda(${d.id})" class="action-btn btn-edit"><i class="fas fa-pen"></i></button><button onclick="deletarDemanda(${d.id})" class="action-btn btn-delete"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        window.avancarStatus = function(id) { 
            const item = demandas.find(d => d.id === id); 
            if(!item) return;
            let novoStatus = item.status;
            let novaDataFim = item.dataFim;
            if(item.status === 'Pendente') novoStatus = 'Em Andamento'; 
            else if(item.status === 'Em Andamento') { novoStatus = 'Concluído'; novaDataFim = new Date().toISOString(); }
            update(ref(db, 'demandas/' + id), { status: novoStatus, dataFim: novaDataFim });
        }

        window.deletarDemanda = function(id) { 
            if(confirm('Excluir?')) { 
                remove(ref(db, 'demandas/' + id));
                if(document.getElementById('demanda-id-edit').value == id) cancelarEdicaoDemanda(); 
            } 
        }

        // --- 2. VISITANTES ---
        const formVis = document.getElementById('form-visitante');
        formVis.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('visitante-id-edit').value;
            const id = idEdicao || Date.now();

            const novoVisitante = {
                id: id,
                nome: document.getElementById('vis-nome').value,
                doc: document.getElementById('vis-doc').value,
                empresa: document.getElementById('vis-empresa').value,
                contato: document.getElementById('vis-contato').value,
                responsavel: document.getElementById('vis-responsavel').value,
                finalidade: document.getElementById('vis-finalidade').value,
                entrada: document.getElementById('vis-entrada').value,
                status: idEdicao ? document.getElementById('vis-status-edit').value : 'Ativo',
                saida: null
            };

            if(idEdicao) {
                const ant = visitantes.find(v => v.id == id);
                if (novoVisitante.status === 'Saiu' && (!ant || !ant.saida)) {
                    novoVisitante.saida = new Date().toISOString();
                } else if (ant && ant.saida) {
                    novoVisitante.saida = ant.saida;
                }
            }
            set(ref(db, 'visitantes/' + id), novoVisitante).then(() => cancelarEdicaoVisitante());
        });

        onValue(ref(db, 'visitantes'), (snapshot) => {
            const data = snapshot.val();
            visitantes = data ? Object.values(data) : [];
            visitantes.sort((a,b) => b.id - a.id);
            window.renderizarApenasVisitantes();
        });

        window.editarVisitante = function(id) {
            const v = visitantes.find(i => i.id === id); if(!v) return;
            document.getElementById('visitante-id-edit').value = v.id;
            document.getElementById('vis-nome').value = v.nome; document.getElementById('vis-doc').value = v.doc;
            document.getElementById('vis-empresa').value = v.empresa; document.getElementById('vis-contato').value = v.contato;
            document.getElementById('vis-responsavel').value = v.responsavel; document.getElementById('vis-finalidade').value = v.finalidade;
            document.getElementById('vis-entrada').value = v.entrada;
            document.getElementById('titulo-form-visitante').innerHTML = '<i class="fas fa-edit"></i> Editando Visitante';
            const btn = document.getElementById('btn-submit-vis'); btn.innerText = "Salvar"; btn.style.background = "var(--edit)";
            document.getElementById('btn-cancel-vis').style.display = "block";
            const selStat = document.getElementById('vis-status-edit'); selStat.style.display="block"; selStat.value = v.status;
            document.getElementById('visitantes').scrollIntoView({behavior:'smooth'});
        }
        
        window.deletarVisitante = function(id) {
            if(confirm('Tem certeza que deseja EXCLUIR este visitante do histórico?')) {
                remove(ref(db, 'visitantes/' + id));
                if(document.getElementById('visitante-id-edit').value == id) cancelarEdicaoVisitante();
            }
        }

        window.cancelarEdicaoVisitante = function() {
            document.getElementById('visitante-id-edit').value = ""; formVis.reset();
            document.getElementById('vis-entrada').value = new Date().toISOString().slice(0,16);
            document.getElementById('titulo-form-visitante').innerHTML = '<i class="fas fa-user-plus"></i> Cadastrar Visitante';
            const btn = document.getElementById('btn-submit-vis'); btn.innerText = "Registrar Entrada"; btn.style.background = "var(--accent)";
            document.getElementById('btn-cancel-vis').style.display = "none"; document.getElementById('vis-status-edit').style.display="none";
        }

        window.renderizarApenasVisitantes = function() {
            const mes = document.getElementById('filtro-mes-vis').value;
            const termo = document.getElementById('filtro-busca-vis').value.toLowerCase();
            const lista = visitantes.filter(v => {
                const bateMes = !mes || v.entrada.startsWith(mes);
                const bateTermo = !termo || v.nome.toLowerCase().includes(termo) || v.doc.includes(termo) || v.empresa.toLowerCase().includes(termo);
                return bateMes && bateTermo;
            });
            document.getElementById('dash-visitantes-ativos').innerText = lista.filter(v => v.status === 'Ativo').length;
            document.getElementById('dash-visitantes-total').innerText = lista.length;
            const tbody = document.querySelector('#tabela-visitantes tbody'); tbody.innerHTML = '';
            lista.forEach(v => {
                const tr = document.createElement('tr');
                const badge = v.status === 'Ativo' ? '<span class="badge bg-visitante-ativo">NA EMPRESA</span>' : '<span class="badge bg-saiu">SAIU</span>';
                const dataEnt = new Date(v.entrada).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
                const dataSai = v.saida ? new Date(v.saida).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
                const btnBaixa = v.status === 'Ativo' ? `<button onclick="baixaVisitante(${v.id})" class="action-btn btn-baixa" title="Registrar Saída"><i class="fas fa-sign-out-alt"></i> Saída</button>` : '<i class="fas fa-check" style="color:green; margin-right:5px"></i>';
                let btnExcluir = '';
                if (currentUserRole === 'admin') btnExcluir = `<button onclick="deletarVisitante(${v.id})" class="action-btn btn-delete" title="Excluir"><i class="fas fa-trash"></i></button>`;
                tr.innerHTML = `<td>${badge}</td><td><strong>${v.nome}</strong><br><small>${v.contato || ''}</small></td><td>${v.empresa || '-'}<br><small>${v.doc}</small></td><td>${v.responsavel}<br><small>${v.finalidade}</small></td><td>Ent: ${dataEnt}<br>Sai: ${dataSai}</td><td style="min-width:140px">${btnBaixa}<button onclick="editarVisitante(${v.id})" class="action-btn btn-edit"><i class="fas fa-pen"></i></button>${btnExcluir}</td>`;
                tbody.appendChild(tr);
            });
        }

        window.baixaVisitante = function(id) { 
            if(confirm('Confirmar saída do visitante?')) { 
                update(ref(db, 'visitantes/' + id), { status: 'Saiu', saida: new Date().toISOString() });
            } 
        }

        // --- 3. VEICULOS (GARAGEM) ---
        window.atualizarLabels = function() {
            const tipo = document.querySelector('input[name="tipoFluxo"]:checked').value;
            const btn = document.getElementById('btn-submit-veiculo');
            if (!document.getElementById('veiculo-id-edit').value) btn.innerText = "Registrar Entrada";
            if (tipo === 'servidor') { btn.style.backgroundColor = "var(--servidor)"; document.getElementById('veiculo-setor').placeholder = "Setor de Origem"; } 
            else { btn.style.backgroundColor = "var(--visitante)"; document.getElementById('veiculo-setor').placeholder = "Empresa / Setor Visitado"; }
        }

        const formVeiculo = document.getElementById('form-veiculo');
        formVeiculo.addEventListener('submit', (e) => {
            e.preventDefault();
            const idEdicao = document.getElementById('veiculo-id-edit').value;
            const id = idEdicao || Date.now();
            const tipo = document.querySelector('input[name="tipoFluxo"]:checked').value;

            const novoVeiculo = {
                id: id,
                tipo: tipo,
                carro: document.getElementById('veiculo-carro').value,
                motorista: document.getElementById('veiculo-motorista').value,
                setor: document.getElementById('veiculo-setor').value,
                contato: document.getElementById('veiculo-contato').value,
                destino: document.getElementById('veiculo-destino').value,
                kmInicial: document.getElementById('veiculo-km-saida').value || 0,
                horaInicial: document.getElementById('veiculo-hora-saida').value,
                status: idEdicao ? document.getElementById('veiculo-status-edit').value : 'Aberto',
                kmFinal: null,
                horaFinal: null
            };

            if(idEdicao) {
                const ant = frota.find(f => f.id == id);
                if (novoVeiculo.status === 'Aberto') {
                    novoVeiculo.horaFinal = null; novoVeiculo.kmFinal = null;
                } else if (ant && ant.horaFinal) {
                    novoVeiculo.horaFinal = ant.horaFinal;
                    novoVeiculo.kmFinal = ant.kmFinal;
                }
            }
            set(ref(db, 'frota/' + id), novoVeiculo).then(() => { cancelarEdicaoVeiculo(); window.atualizarLabels(); });
        });

        onValue(ref(db, 'frota'), (snapshot) => {
            const data = snapshot.val();
            frota = data ? Object.values(data) : [];
            frota.sort((a,b) => b.id - a.id);
            window.renderizarApenasFrota();
        });

        window.editarVeiculo = function(id) {
            const f = frota.find(i => i.id === id); if (!f) return;
            document.getElementById('veiculo-id-edit').value = f.id;
            document.getElementById('veiculo-carro').value = f.carro; document.getElementById('veiculo-motorista').value = f.motorista;
            document.getElementById('veiculo-setor').value = f.setor || ''; document.getElementById('veiculo-contato').value = f.contato || '';
            document.getElementById('veiculo-destino').value = f.destino; document.getElementById('veiculo-km-saida').value = f.kmInicial;
            document.getElementById('veiculo-hora-saida').value = f.horaInicial;
            if (f.tipo === 'servidor') document.getElementById('radio-servidor').checked = true; else document.getElementById('radio-visitante').checked = true;

            document.getElementById('titulo-form-veiculo').innerHTML = '<i class="fas fa-edit"></i> Editando';
            const btn = document.getElementById('btn-submit-veiculo'); btn.innerText = "Salvar"; btn.style.backgroundColor = "var(--edit)";
            document.getElementById('btn-cancel-veiculo').style.display = "block";
            document.getElementById('container-status-veiculo').style.display = "block"; document.getElementById('veiculo-status-edit').value = f.status;
            window.atualizarLabels(); document.getElementById('veiculos').scrollIntoView({behavior: 'smooth'});
        }

        window.deletarVeiculo = function(id) {
            if(confirm('Tem certeza que deseja EXCLUIR este registro da garagem?')) {
                remove(ref(db, 'frota/' + id));
                if(document.getElementById('veiculo-id-edit').value == id) cancelarEdicaoVeiculo();
            }
        }

        window.cancelarEdicaoVeiculo = function() {
            document.getElementById('veiculo-id-edit').value = ""; formVeiculo.reset();
            document.getElementById('titulo-form-veiculo').innerHTML = '<i class="fas fa-parking"></i> Registrar Entrada';
            document.getElementById('btn-cancel-veiculo').style.display = "none"; document.getElementById('container-status-veiculo').style.display = "none";
            document.getElementById('radio-servidor').checked = true; window.atualizarLabels();
        }

        window.renderizarApenasFrota = function() {
            const mes = document.getElementById('filtro-mes-frota').value;
            const busca = document.getElementById('filtro-busca-frota').value.toLowerCase();
            const lista = frota.filter(f => {
                const bData = !mes || f.horaInicial.startsWith(mes);
                const bTexto = !busca || (f.motorista+f.carro+f.setor).toLowerCase().includes(busca);
                return bData && bTexto;
            });
            document.getElementById('dash-frota-total').innerText = lista.length;
            document.getElementById('dash-frota-estacionados').innerText = lista.filter(f => f.status === 'Aberto').length;
            document.getElementById('dash-servidor-count').innerText = lista.filter(f => f.tipo === 'servidor').length;
            document.getElementById('dash-visitante-count').innerText = lista.filter(f => f.tipo === 'visitante').length;
            const tbody = document.querySelector('#tabela-veiculos tbody'); tbody.innerHTML = '';
            lista.forEach(f => {
                const tr = document.createElement('tr');
                const badge = f.status === 'Aberto' ? '<span class="badge bg-estacionado">ESTACIONADO</span>' : '<span class="badge bg-saiu">FINALIZADO</span>';
                const icon = f.tipo === 'servidor' ? '<i class="fas fa-id-badge" style="color:var(--servidor)"></i> Servidor' : '<i class="fas fa-user-tag" style="color:var(--visitante)"></i> Visitante';
                const dIn = new Date(f.horaInicial).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
                const dOut = f.horaFinal ? new Date(f.horaFinal).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '-';
                const btnBaixa = f.status === 'Aberto' ? `<button onclick="baixaVeiculo(${f.id})" class="action-btn btn-baixa"><i class="fas fa-sign-out-alt"></i> Saída</button>` : '<i class="fas fa-check" style="color:green; margin-right:5px"></i>';
                let btnExcluir = '';
                if (currentUserRole === 'admin') btnExcluir = `<button onclick="deletarVeiculo(${f.id})" class="action-btn btn-delete" title="Excluir"><i class="fas fa-trash"></i></button>`;
                tr.innerHTML = `<td>${badge}</td><td><small>${icon}</small></td><td><strong>${f.motorista}</strong><br><small>${f.contato||''}</small></td><td>${f.carro}</td><td>${f.setor||'-'}</td><td style="font-size:0.85rem">Ent: ${dIn}<br>Sai: ${dOut}</td><td style="min-width:140px">${btnBaixa}<button onclick="editarVeiculo(${f.id})" class="action-btn btn-edit"><i class="fas fa-pen"></i></button>${btnExcluir}</td>`;
                tbody.appendChild(tr);
            });
        }

        window.baixaVeiculo = function(id) {
            const km = prompt("KM de Saída (Opcional):", "0");
            if (km !== null) { 
                update(ref(db, 'frota/' + id), { kmFinal: km, horaFinal: new Date().toISOString(), status: 'Fechado' });
            }
        }
    </script>
</body>
</html>